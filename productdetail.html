<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Details | ZKRAZE</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background: #fff; color: #111; overflow-x: hidden; }

    /* ---------- HEADER ---------- */
    header {
      background: #f5ecd7;
      color: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px 20px;
      border-bottom: 1px solid #f1e6c8;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .logo {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 28px;
      color: #111;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    .back-btn {
      position: absolute;
      left: 20px;
      background: transparent;
      border: none;
      font-size: 28px;
      cursor: pointer;
      color: #111;
      display: flex;
      align-items: center;
    }
    #cartContainer {
      position: absolute;
      right: 28px;
      top: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      background: transparent;
      padding: 6px 10px;
      min-width: 41px;
      min-height: 41px;
      transition: 0.3s;
    }
    #cartContainer .material-icons { font-size: 26px; color: #111; }
    #cartCount {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ed8439;
      color: #fff;
      border-radius: 50%;
      padding: 3px 7px;
      font-size: 12px;
      font-weight: 700;
      line-height: 14px;
      box-shadow: 0 0 5px rgba(0,0,0,0.15);
    }

    /* ---------- LAYOUT ---------- */
    .container {
      max-width: 1100px;
      margin: 40px auto;
      padding: 20px;
      display: flex;
      flex-wrap: wrap;
      gap: 40px;
    }

    .image-viewer {
      flex: 1 1 45%;
      overflow: hidden;
      border-radius: 10px;
      border: 1px solid #ededed;
      background: #fff;
      position: relative;
    }

    .image-slider {
      display: flex;
      transition: transform 0.4s ease;
      width: 100%;
      touch-action: pan-y;
    }
    .image-slider img {
      width: 100%;
      height: auto;
      object-fit: contain;
      flex-shrink: 0;
      cursor: zoom-in;
      image-rendering: crisp-edges;
    }
    .image-slider img.zoomed { transform: scale(1.5); cursor: zoom-out; }

    .info {
      flex: 1 1 50%;
      text-align: left;
    }
    .product-title {
      font-size: 28px;
      font-weight: 700;
      color: #111;
      letter-spacing: 1px;
      text-transform: uppercase;
      margin-bottom: 10px;
    }
    .price-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 15px 0 25px;
    }
    .mrp { color: #888; font-size: 20px; text-decoration: line-through; font-weight: 500; }
    .price { font-size: 28px; font-weight: 800; color: #ed8439; }

    .sizes { margin: 25px 0; display: flex; flex-wrap: wrap; gap: 10px; }
    .sizes button {
      background: #f5ecd7;
      color: #111;
      border: 2px solid #bca673;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border-radius: 6px;
      font-size: 15px;
    }
    .sizes button:hover { border-color: #ed8439; }
    .sizes button.active { border-color: #00b894; background: #ececec; }
    .sizes button.error { border-color: #ff0000; }

    .qty {
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 20px 0 30px;
    }
    .qty button {
      background: #e0d4bc;
      color: #111;
      width: 38px;
      height: 38px;
      border: none;
      font-size: 20px;
      cursor: pointer;
      font-weight: 700;
      border-radius: 5px;
    }
    .qty input {
      width: 55px;
      text-align: center;
      border: none;
      background: #f5ecd7;
      color: #111;
      font-weight: 700;
      font-size: 17px;
      border-radius: 3px;
    }

    .btn-group {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .add-cart, .share-btn {
      flex: 1;
      background: #111;
      color: white;
      border: none;
      padding: 14px 25px;
      font-weight: 700;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      text-transform: uppercase;
      transition: 0.3s;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    .add-cart:hover { background: #ed8439; }
    .share-btn { background: #ed8439; }
    .share-btn:hover { background: #111; }

    .desc { margin-top: 35px; color: #333; line-height: 1.7; }

    /* ---------- SIMILAR ---------- */
    .similar { margin-top: 60px; overflow: hidden; }
    .similar h3 { font-size: 22px; color: #ed8439; margin-bottom: 18px; }
    .similar-grid {
      display: flex;
      gap: 16px;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding-bottom: 8px;
      scrollbar-width: none;
    }
    .similar-grid::-webkit-scrollbar { display: none; }
    .similar-item {
      flex: 0 0 180px;
      background: #fff;
      border: 1px solid #ededed;
      text-align: center;
      padding: 12px;
      cursor: pointer;
      transition: 0.3s;
      border-radius: 10px;
    }
    .similar-item img {
      width: 100%;
      height: 180px;
      object-fit: contain;
      margin-bottom: 8px;
      image-rendering: crisp-edges;
    }
    .similar-item h4 { font-size: 14px; font-weight: 600; color: #111; margin-bottom: 3px; }
    .similar-item p { font-size: 14px; font-weight: 700; color: #ed8439; }
    .similar-item:hover { transform: translateY(-3px); border-color: #ed8439; }

    /* ---------- MOBILE ---------- */
    @media (max-width: 768px) {
      .container { flex-direction: column; gap: 25px; }
      .logo { font-size: 20px; }
      .info { text-align: center; }
      .add-cart, .share-btn { width: 48%; font-size: 15px; }
      .btn-group { justify-content: center; }
      .similar-item { flex: 0 0 160px; }
      .similar-item img { height: 160px; }
      .product-title { font-size: 22px; }
    }

    /* ---------- TOAST ---------- */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 3000;
    }
    .toast {
      background: rgba(250,240,230,0.98);
      border: 1px solid #f6e5ca;
      color: #111;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 3px 10px rgba(0,0,0,0.14);
      opacity: 0;
      transform: translateY(-10px);
      animation: slideIn 0.4s forwards;
    }
    .toast.success { border-left: 5px solid #00b894; }
    .toast.error { border-left: 5px solid #ed8439; }
    @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>
<body>
  <header>
    <button class="back-btn" onclick="history.back()">
      <span class="material-icons">arrow_back</span>
    </button>
    <div class="logo">ZKRAZE</div>
    <div id="cartContainer" onclick="location.href='cart.html'">
      <span class="material-icons">shopping_bag</span>
      <span id="cartCount">0</span>
    </div>
  </header>

  <div class="container">
    <div class="image-viewer">
      <div class="image-slider" id="imageSlider"></div>
    </div>

    <div class="info">
      <h2 class="product-title" id="pname"></h2>
      <div class="price-wrap">
        <span class="mrp" id="pmrp"></span>
        <span class="price" id="pprice"></span>
      </div>
      <div class="sizes" id="psizes"></div>
      <div class="qty">
        <button onclick="changeQty(-1)">-</button>
        <input type="text" id="quantity" value="1" readonly />
        <button onclick="changeQty(1)">+</button>
      </div>
      <div class="btn-group">
        <button class="add-cart" onclick="addToCart()">
          <span class="material-icons">add_shopping_cart</span> Add to Cart
        </button>
        <button class="share-btn" onclick="shareProduct()">
          <span class="material-icons">share</span> Share
        </button>
      </div>
      <p class="desc" id="pdesc"></p>
    </div>
  </div>

  <div class="container similar">
    <h3>Similar Products</h3>
    <div class="similar-grid" id="similarGrid"></div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const backendURL = "https://reacher-backend-production.up.railway.app";
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");
    const type = urlParams.get("type") || "product";
    const apiEndpoint = type === "hoodie" ? "hoodies" : "products";

    let product = null, currentImageIndex = 0;

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const totalQty = cart.reduce((sum, item) => sum + (item.quantity || 1), 0);
      document.getElementById("cartCount").innerText = totalQty || '';
    }
    updateCartCount();

    function showToast(msg, type = "success") {
      const c = document.getElementById("toastContainer");
      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => {
        t.style.opacity = "0";
        t.style.transform = "translateY(-10px)";
        setTimeout(() => t.remove(), 400);
      }, 2000);
    }

    async function loadProduct() {
      try {
        const res = await fetch(`${backendURL}/api/${apiEndpoint}/${id}`);
        product = await res.json();

        document.getElementById("pname").textContent = product.name;
        document.getElementById("pprice").textContent = "₹" + product.price;
        document.getElementById("pdesc").textContent = product.description;
        if (product.oldPrice && product.oldPrice !== product.price) {
          document.getElementById("pmrp").textContent = "₹" + product.oldPrice;
        }

        const allImages = (product.images || []).map(img => img.replace("http://localhost:5000", backendURL));
        const slider = document.getElementById("imageSlider");
        slider.innerHTML = allImages.map(src => `<img src="${src}" alt="Product image">`).join("");

        initSwipe(slider, allImages.length);

        const sizeKeys = Object.keys(product.sizes || {}).filter(s => s && s !== "_id");
        document.getElementById("psizes").innerHTML = sizeKeys.map(s => `<button onclick="selectSize(this)">${s}</button>`).join("");

        loadSimilar();
      } catch (err) {
        console.error(err);
        showToast("Product not found!", "error");
      }
    }

    function selectSize(btn) {
      document.querySelectorAll(".sizes button").forEach(b => b.classList.remove("active", "error"));
      btn.classList.add("active");
    }

    function changeQty(n) {
      const input = document.getElementById("quantity");
      let q = parseInt(input.value) + n;
      if (q < 1) q = 1;
      input.value = q;
    }

    function addToCart() {
      const selected = document.querySelector(".sizes button.active");
      if (!selected) {
        document.querySelectorAll(".sizes button").forEach(b => b.classList.add("error"));
        showToast("Please select a size!", "error");
        return;
      }
      const selectedSize = selected.textContent.trim();
      const quantity = parseInt(document.getElementById("quantity").value);
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const existing = cart.find(i => i._id === product._id && i.size === selectedSize);
      if (existing) existing.quantity = (existing.quantity || 1) + quantity;
      else cart.push({ _id: product._id, name: product.name, image: product.images?.[0] || "", price: product.price, size: selectedSize, quantity, type });
      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount();
      showToast("Added to cart!", "success");
      setTimeout(() => location.href = "cart.html", 1000);
    }

    async function loadSimilar() {
      try {
        const res = await fetch(`${backendURL}/api/${apiEndpoint}`);
        const data = await res.json();
        const similar = data.filter(p => p._id !== id);
        document.getElementById("similarGrid").innerHTML = similar.slice(0, 10)
          .map(p => `
            <div class="similar-item" onclick="location.href='productdetail.html?id=${p._id}&type=${type}'">
              <img src="${p.images?.[0]?.replace('http://localhost:5000', backendURL) || ''}" alt="${p.name}">
              <h4>${p.name}</h4>
              <p>${p.oldPrice ? `<span style='text-decoration:line-through;color:#888;font-weight:500;margin-right:4px;'>₹${p.oldPrice}</span>` : ''} ₹${p.price}</p>
            </div>`).join("");
      } catch (err) {
        console.error("Failed to load similar:", err);
      }
    }

    // Swipe for product images
    function initSwipe(slider, count) {
      let startX = 0, currentIndex = 0;
      slider.addEventListener("touchstart", e => { startX = e.touches[0].clientX; });
      slider.addEventListener("touchmove", e => {
        if (!startX) return;
        const diff = e.touches[0].clientX - startX;
        if (Math.abs(diff) > 60) {
          if (diff > 0) currentIndex = Math.max(0, currentIndex - 1);
          else currentIndex = Math.min(count - 1, currentIndex + 1);
          slider.style.transform = `translateX(-${currentIndex * 100}%)`;
          startX = 0;
        }
      });
    }

    function shareProduct() {
      if (navigator.share) {
        navigator.share({ title: product.name, text: product.description, url: window.location.href })
          .catch(() => {});
      } else {
        navigator.clipboard.writeText(window.location.href);
        showToast("Link copied to clipboard!", "success");
      }
    }

    loadProduct();
  </script>
</body>
</html>
