<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Product Details | ZKRAZE</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@400;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Poppins", sans-serif; }
    body { background: #fff; color: #111; overflow-x: hidden; }

    /* HEADER */
    header {
      background: #f5ecd7;
      color: #111;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 15px 20px;
      border-bottom: 1px solid #f1e6c8;
      position: sticky;
      top: 0;
      z-index: 1000;
    }
    .logo {
      font-family: 'Playfair Display', serif;
      font-weight: 700;
      font-size: 28px;
      color: #111;
      letter-spacing: 2px;
      text-transform: uppercase;
    }
    #cartContainer {
      position: absolute;
      right: 28px;
      top: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 6px;
      cursor: pointer;
      background: transparent;
      padding: 6px 10px;
      min-width: 41px;
      min-height: 41px;
      transition: 0.3s;
    }
    #cartContainer .material-icons { font-size: 26px; color: #111; }
    #cartContainer:hover { background: #f5ecd7; }
    #cartCount {
      position: absolute;
      top: -4px;
      right: -4px;
      background: #ed8439;
      color: #fff;
      border-radius: 50%;
      padding: 3px 7px;
      font-size: 12px;
      font-weight: 700;
      line-height: 14px;
      box-shadow: 0 0 5px rgba(0,0,0,0.15);
    }

    .container { max-width: 1100px; margin: 30px auto; padding: 20px; }

    /* IMAGE VIEWER */
    .image-viewer {
      position: relative;
      width: 100%;
      max-width: 550px;
      margin: 0 auto;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid #ededed;
      background: #fff;
    }
    .image-viewer img {
      width: 100%;
      height: auto;
      object-fit: cover;
      display: block;
      transition: transform 0.3s;
      cursor: zoom-in;
    }
    .image-viewer img.zoomed { transform: scale(1.5); cursor: zoom-out; }
    .arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.18);
      border: none;
      color: #111;
      font-size: 26px;
      padding: 8px 12px;
      cursor: pointer;
      border-radius: 50%;
      z-index: 10;
    }
    .arrow.left { left: 10px; }
    .arrow.right { right: 10px; }

    /* PRODUCT INFO */
    .info { text-align: center; margin-top: 25px; }
    .product-title {
      font-size: 24px;
      font-weight: 700;
      color: #111;
      margin-top: 15px;
      letter-spacing: 1px;
      text-transform: uppercase;
    }
    .price-wrap {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin: 15px 0 25px;
    }
    .mrp {
      color: #888;
      font-size: 20px;
      text-decoration: line-through;
      font-weight: 500;
      display: inline-block;
    }
    .price {
      font-size: 28px;
      font-weight: 800;
      color: #ed8439;
      display: inline-block;
    }

    .sizes { margin: 25px 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
    .sizes button {
      background: #f5ecd7;
      color: #111;
      border: 2px solid #bca673;
      padding: 10px 20px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      border-radius: 6px;
      font-size: 15px;
    }
    .sizes button:hover { border-color: #ed8439; }
    .sizes button.active { border-color: #00b894; background: #ececec; }
    .sizes button.error { border-color: #ff0000; }

    .qty {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 12px;
      margin: 20px 0 30px;
    }
    .qty button {
      background: #e0d4bc;
      color: #111;
      width: 38px;
      height: 38px;
      border: none;
      font-size: 20px;
      cursor: pointer;
      font-weight: 700;
      border-radius: 5px;
    }
    .qty input {
      width: 55px;
      text-align: center;
      border: none;
      background: #f5ecd7;
      color: #111;
      font-weight: 700;
      font-size: 17px;
      border-radius: 3px;
    }

    .add-cart {
      background: #111;
      color: white;
      border: none;
      padding: 14px 40px;
      font-weight: 700;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      text-transform: uppercase;
      transition: 0.3s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin-top: 10px;
    }
    .add-cart:hover { background: #ed8439; }

    .desc { margin-top: 35px; color: #333; line-height: 1.7; text-align: left; }

    /* SIMILAR PRODUCTS */
    .similar { margin-top: 60px; overflow: hidden; }
    .similar h3 { font-size: 20px; color: #ed8439; margin-bottom: 18px; }
    .similar-grid {
      display: flex;
      gap: 14px;
      overflow-x: auto;
      scroll-behavior: smooth;
      padding-bottom: 8px;
      scrollbar-width: none;
    }
    .similar-grid::-webkit-scrollbar { display: none; }
    .similar-item {
      flex: 0 0 130px;
      background: #fff;
      border: 1px solid #ededed;
      text-align: center;
      padding: 8px;
      cursor: pointer;
      transition: 0.3s;
      border-radius: 6px;
    }
    .similar-item img { width: 100%; height: 130px; object-fit: contain; margin-bottom: 5px; }
    .similar-item h4 { font-size: 13px; font-weight: 600; margin-bottom: 3px; color: #111; }
    .similar-item p { font-size: 13px; font-weight: 700; color: #ed8439; }
    .similar-item:hover { transform: translateY(-3px); border-color: #ed8439; }

    @media (max-width: 768px) {
      .logo { font-size: 20px; }
      .add-cart { width: 100%; font-size: 15px; }
      .desc { font-size: 14px; }
      .similar-item { flex: 0 0 100px; }
      .similar-item img { height: 100px; }
      .similar-item h4, .similar-item p { font-size: 12px; }
    }

    /* Toast */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 3000;
    }
    .toast {
      background: rgba(250,240,230,0.98);
      border: 1px solid #f6e5ca;
      color: #111;
      padding: 12px 18px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      box-shadow: 0 3px 10px rgba(0,0,0,0.14);
      opacity: 0;
      transform: translateY(-10px);
      animation: slideIn 0.4s forwards;
    }
    .toast.success { border-left: 5px solid #00b894; }
    .toast.error { border-left: 5px solid #ed8439; }
    @keyframes slideIn { to { opacity: 1; transform: translateY(0); } }
  </style>
</head>

<body>
  <header>
    <div class="logo">ZKRAZE</div>
    <div id="cartContainer" onclick="location.href='cart.html'">
      <span class="material-icons">shopping_bag</span>
      <span id="cartCount">0</span>
    </div>
  </header>

  <div class="container">
    <div class="image-viewer">
      <button class="arrow left" onclick="prevImage()">❮</button>
      <img id="mainImage" src="" alt="Product Image" />
      <button class="arrow right" onclick="nextImage()">❯</button>
    </div>

    <div class="info">
      <h2 class="product-title" id="pname"></h2>
      <div class="price-wrap">
        <span class="mrp" id="pmrp"></span>
        <span class="price" id="pprice"></span>
      </div>
      <div class="sizes" id="psizes"></div>
      <div class="qty">
        <button onclick="changeQty(-1)">-</button>
        <input type="text" id="quantity" value="1" readonly />
        <button onclick="changeQty(1)">+</button>
      </div>
      <button class="add-cart" onclick="addToCart()">
        <span class="material-icons">add_shopping_cart</span> Add to Cart
      </button>
      <p class="desc" id="pdesc"></p>
    </div>

    <div class="similar">
      <h3>Similar Products</h3>
      <div class="similar-grid" id="similarGrid"></div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    const backendURL = "https://reacher-backend-production.up.railway.app";
    const urlParams = new URLSearchParams(window.location.search);
    const id = urlParams.get("id");
    const type = urlParams.get("type") || "product";
    const apiEndpoint = type === "hoodie" ? "hoodies" : "products";

    let product = null, currentImageIndex = 0;

    function updateCartCount() {
      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      document.getElementById("cartCount").innerText = cart.length || '';
    }
    updateCartCount();

    function showToast(msg, type = "success") {
      const c = document.getElementById("toastContainer");
      const t = document.createElement("div");
      t.className = `toast ${type}`;
      t.textContent = msg;
      c.appendChild(t);
      setTimeout(() => {
        t.style.opacity = "0";
        t.style.transform = "translateY(-10px)";
        setTimeout(() => t.remove(), 400);
      }, 2000);
    }

    async function loadProduct() {
      try {
        const res = await fetch(`${backendURL}/api/${apiEndpoint}/${id}`);
        product = await res.json();

        document.getElementById("pname").textContent = product.name;

        // ✅ Show strike-through old price
        if (product.oldPrice && product.oldPrice !== product.price) {
          document.getElementById("pmrp").textContent = "₹" + product.oldPrice;
          document.getElementById("pmrp").style.display = "inline";
        } else {
          document.getElementById("pmrp").style.display = "none";
        }

        document.getElementById("pprice").textContent = "₹" + product.price;
        document.getElementById("pdesc").textContent = product.description;

        const allImages = (product.images || []).map(img => img.replace("http://localhost:5000", backendURL));
        if (allImages.length > 0) document.getElementById("mainImage").src = allImages[0];

        const sizeKeys = Object.keys(product.sizes || {}).filter(s => s && s !== "_id");
        document.getElementById("psizes").innerHTML = sizeKeys
          .map(s => `<button onclick="selectSize(this)">${s}</button>`)
          .join("");

        loadSimilar();
      } catch (err) {
        console.error(err);
        showToast("Product not found!", "error");
      }
    }

    function nextImage() {
      const imgs = product.images || [];
      if (!imgs.length) return;
      currentImageIndex = (currentImageIndex + 1) % imgs.length;
      document.getElementById("mainImage").src = imgs[currentImageIndex];
    }

    function prevImage() {
      const imgs = product.images || [];
      if (!imgs.length) return;
      currentImageIndex = (currentImageIndex - 1 + imgs.length) % imgs.length;
      document.getElementById("mainImage").src = imgs[currentImageIndex];
    }

    document.addEventListener("click", e => {
      if (e.target.id === "mainImage") e.target.classList.toggle("zoomed");
    });

    function selectSize(btn) {
      document.querySelectorAll(".sizes button").forEach(b => b.classList.remove("active", "error"));
      btn.classList.add("active");
    }

    function changeQty(n) {
      const input = document.getElementById("quantity");
      let q = parseInt(input.value) + n;
      if (q < 1) q = 1;
      input.value = q;
    }

    // ✅ Improved add-to-cart logic
    function addToCart() {
      const selected = document.querySelector(".sizes button.active");
      if (!selected) {
        document.querySelectorAll(".sizes button").forEach(b => b.classList.add("error"));
        showToast("Please select a size!", "error");
        return;
      }

      const selectedSize = selected.textContent.trim();
      const quantity = parseInt(document.getElementById("quantity").value);

      const cart = JSON.parse(localStorage.getItem("cart") || "[]");
      const existing = cart.find(item => item._id === product._id && item.size === selectedSize);

      if (existing) {
        existing.quantity += quantity; // increase qty if exists
      } else {
        cart.push({
          _id: product._id,
          name: product.name,
          image: product.images?.[0] || "",
          price: product.price,
          oldPrice: product.oldPrice || null,
          size: selectedSize,
          quantity,
          type
        });
      }

      localStorage.setItem("cart", JSON.stringify(cart));
      updateCartCount();
      showToast("Added to cart!", "success");
      setTimeout(() => location.href = "cart.html", 1000);
    }

    async function loadSimilar() {
      try {
        const res = await fetch(`${backendURL}/api/${apiEndpoint}`);
        const data = await res.json();
        const similar = data.filter(p => p._id !== id);
        document.getElementById("similarGrid").innerHTML = similar.slice(0, 10)
          .map(p => `
            <div class="similar-item" onclick="location.href='productdetail.html?id=${p._id}&type=${type}'">
              <img src="${p.images?.[0]?.replace('http://localhost:5000', backendURL) || ''}" alt="${p.name}">
              <h4>${p.name}</h4>
              <p>
                ${p.oldPrice ? `<span style="text-decoration:line-through;color:#888;font-weight:500;margin-right:4px;">₹${p.oldPrice}</span>` : ''} ₹${p.price}
              </p>
            </div>`).join("");
      } catch (err) {
        console.error("Failed to load similar:", err);
      }
    }

    loadProduct();
  </script>
</body>
</html>
