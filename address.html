<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Delivery Address | ZKRAZE</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Playfair+Display:wght@500;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { background: #fff; color: #111; font-family: "Poppins", sans-serif; }

    /* Header */
    header {
      background: #f5ecd7;
      color: #111;
      position: sticky;
      top: 0;
      z-index: 1000;
      height: 63px;
      border-bottom: 2px solid #ed8439;
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }
    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      font-weight: 700;
      color: #111;
      letter-spacing: 2px;
      text-transform: uppercase;
      text-align: center;
      position: absolute;
      left: 50%;
      top: 50%;
      transform: translateX(-50%) translateY(-50%);
    }
    .header-btn {
      position: absolute;
      right: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: #ed8439;
      color: white;
      border: none;
      border-radius: 8px;
      padding: 11px 20px;
      font-size: 16px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: background 0.2s;
      box-shadow: 0 2px 8px rgba(237, 132, 57, 0.08);
    }
    .header-btn:hover { background: #c79151; }

    /* Container */
    .container {
      max-width: 600px;
      background: #f9f6ef;
      margin: 40px auto;
      padding: 36px 30px;
      border-radius: 14px;
      box-shadow: 0 0 10px rgba(237, 132, 57, 0.11);
    }
    h2 {
      text-align: center;
      color: #ed8439;
      font-family: 'Playfair Display', serif;
      margin-bottom: 25px;
      font-size: 23px;
    }
    label { display: block; margin-bottom: 6px; font-weight: 600; color: #6d665e; font-size: 16px; }
    input, textarea {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 15px;
      border: 1px solid #eedbbf;
      border-radius: 7px;
      background: #fff;
      font-size: 15px;
      transition: border 0.3s;
    }
    input:focus, textarea:focus { border-color: #ed8439; }
    textarea { resize: none; height: 70px; }
    .btn, .location-btn {
      display: block;
      width: 100%;
      padding: 13px;
      font-weight: 700;
      border: none;
      border-radius: 7px;
      font-size: 15px;
      cursor: pointer;
      transition: 0.3s;
      box-shadow: 0 2px 8px rgba(237,132,57,0.08);
      margin-bottom: 10px;
    }
    .btn { background: #ed8439; color: white; text-transform: uppercase; }
    .btn:hover { background: #c79151; }
    .location-btn { background: #eedbbf; color: #111; font-weight: 600; }
    .location-btn:hover { background: #ed8439; color: #fff; }
    .location-status { text-align: center; font-size: 14px; color: #999; min-height: 21px; margin-bottom: 10px; }

    /* Map Modal */
    #mapModal {
      display: none;
      position: fixed;
      z-index: 3000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.6);
      justify-content: center;
      align-items: center;
    }
    #mapContainer {
      width: 90%;
      max-width: 600px;
      height: 400px;
      background: #fff;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    #map { width: 100%; height: 100%; }
    #closeMap {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #ed8439;
      color: #fff;
      border: none;
      border-radius: 50%;
      width: 32px;
      height: 32px;
      cursor: pointer;
      font-size: 18px;
    }

    .toast {
      visibility: hidden;
      min-width: 260px;
      background-color: #ed8439;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 14px;
      position: fixed;
      z-index: 4000;
      left: 50%;
      bottom: 30px;
      transform: translateX(-50%);
      border: 1px solid #c79151;
      font-size: 15px;
      opacity: 0;
      transition: opacity 0.5s, bottom 0.5s;
    }
    .toast.show { visibility: visible; opacity: 1; bottom: 57px; }
    .field-error { border-color: #ee3636 !important; }

    @media (max-width: 600px) {
      .logo { font-size: 20px; }
      .container { margin: 20px; padding: 17px; }
      h2 { font-size: 18px; }
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">ZKRAZE</div>
    <button class="header-btn" onclick="window.location.href='cart.html'">
      <span class="material-icons">arrow_back</span> Back to Cart
    </button>
  </header>

  <div class="container">
    <h2>Delivery Address</h2>
    <form id="addressForm" novalidate>
      <label for="name">Full Name *</label>
      <input type="text" id="name" required />
      <label for="phone">Phone Number (India) *</label>
      <input type="tel" id="phone" required placeholder="10-digit number, e.g. 9876543210" />
      <label for="email">Email *</label>
      <input type="email" id="email" required placeholder="name@example.com" />
      <label for="address1">Address Line 1 ,flat no,village,street,*</label>
      <textarea id="address1" required placeholder="Flat 12B, Building Rosewood"></textarea>
      <label for="address2">Landmark / Nearby *</label>
      <textarea id="address2" required placeholder="Near Apollo Hospital or any landmark"></textarea>
      <label for="city">City *</label>
      <input type="text" id="city" required />
      <label for="state">State *</label>
      <input type="text" id="state" required />
      <label for="pincode">Pincode *</label>
      <input type="text" id="pincode" pattern="[0-9]{6}" required placeholder="6-digit pincode" />

      <button type="button" class="location-btn" onclick="detectLocation()">Use Current Location</button>
      <button type="button" class="location-btn" onclick="openMap()">üìç Select on Map</button>

      <div id="locationStatus" class="location-status"></div>
      <button type="submit" class="btn">Proceed to Payment</button>
    </form>
  </div>

  <div id="mapModal">
    <div id="mapContainer">
      <button id="closeMap">&times;</button>
      <div id="map"></div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <script>
    const toast = document.getElementById("toast");
    const statusEl = document.getElementById("locationStatus");

    function showToast(message, color = "#ed8439") {
      toast.textContent = message;
      toast.style.backgroundColor = color;
      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3500);
    }

    // --- Location autofill ---
    async function fillAddress(lat, lon) {
      try {
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&addressdetails=1`);
        const data = await res.json();
        const addr = data.address || {};
        const clean = str => str ? str.replace(/\s*\b(Taluk|Urban|India)\b\s*/gi, '').trim() : '';
        const area = clean(addr.suburb || addr.village || addr.neighbourhood || '');
        const road = clean(addr.road || '');
        document.getElementById("address1").value = [road, area].filter(Boolean).join(", ");
        document.getElementById("address2").value = clean(addr.landmark || addr.attraction || addr.locality || area);
        document.getElementById("city").value = clean(addr.city || addr.town || addr.village || "");
        document.getElementById("state").value = addr.state || "";
        document.getElementById("pincode").value = addr.postcode || "";
        showToast("Location detected successfully!", "#00bd85");
        statusEl.textContent = "Location detected ‚úî";
        statusEl.style.color = "#00bd85";
      } catch {
        showToast("Unable to fetch address details.", "#ee3636");
      }
    }

    function detectLocation() {
      if (!navigator.geolocation) return showToast("Geolocation not supported.", "#ee3636");
      statusEl.textContent = "Detecting location...";
      statusEl.style.color = "#999";
      navigator.geolocation.getCurrentPosition(
        pos => fillAddress(pos.coords.latitude, pos.coords.longitude),
        () => showToast("Permission denied or unavailable.", "#ee3636")
      );
    }

    // --- Map Modal ---
    let map;
    function openMap() {
      const modal = document.getElementById("mapModal");
      modal.style.display = "flex";
      setTimeout(() => {
        if (!map) {
          map = L.map("map").setView([12.9716, 77.5946], 13);
          L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
            attribution: '&copy; OpenStreetMap contributors'
          }).addTo(map);
          let marker;
          map.on("click", e => {
            if (marker) map.removeLayer(marker);
            marker = L.marker(e.latlng).addTo(map);
            fillAddress(e.latlng.lat, e.latlng.lng);
            showToast("Location selected from map!", "#00bd85");
            modal.style.display = "none";
          });
        }
      }, 200);
    }
    document.getElementById("closeMap").onclick = () => (document.getElementById("mapModal").style.display = "none");

    // --- Validation & Save ---
    document.getElementById("addressForm").addEventListener("submit", e => {
      e.preventDefault();
      const name = document.getElementById("name").value.trim();
      const phone = document.getElementById("phone").value.trim();
      const email = document.getElementById("email").value.trim();
      const address1 = document.getElementById("address1").value.trim();
      const address2 = document.getElementById("address2").value.trim();
      const city = document.getElementById("city").value.trim();
      const state = document.getElementById("state").value.trim();
      const pincode = document.getElementById("pincode").value.trim();

      if (!name || !phone || !email || !address1 || !address2 || !city || !state || !pincode)
        return showToast("Please fill all required fields!", "#ee3636");
      if (!/^[6-9]\d{9}$/.test(phone))
        return showToast("Invalid phone number!", "#ee3636");
      if (!/^\d{6}$/.test(pincode))
        return showToast("Invalid pincode!", "#ee3636");

      const addressObj = { name, phone, email, address1, address2, city, state, pincode, savedAt: new Date().toISOString() };
      localStorage.setItem("userAddress", JSON.stringify(addressObj));
      showToast("Address saved! Redirecting...", "#00bd85");
      setTimeout(() => (window.location.href = "payment.html"), 1200);
    });
  </script>
</body>
</html>
